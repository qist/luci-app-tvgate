#!/bin/sh /etc/rc.common

START=99
STOP=15

USE_PROCD=1

BIN_PATH="/usr/bin/tvgate/TVGate"
CONFIG_PATH="/etc/tvgate/config.yaml"

start_service() {
    local enabled

    enabled="$(uci -q get tvgate.@tvgate[0].enabled)"
    [ "$enabled" != "1" ] && {
        logger -t tvgate "TVGate disabled in UCI"
        return 0
    }

    [ ! -x "$BIN_PATH" ] && {
        logger -t tvgate "TVGate binary not found: $BIN_PATH"
        return 1
    }

    mkdir -p /etc/tvgate

    procd_open_instance
    procd_set_param command "$BIN_PATH" "-config=$CONFIG_PATH"

    procd_set_param respawn

    # 明确告诉 procd：这是前台程序
    procd_set_param stdout 1
    procd_set_param stderr 1

    procd_close_instance
}

stop_service() {
    # 正确停止 TVGate 进程
    for pid in $(pidof "$BIN_PATH"); do
        [ -e "/proc/$pid/stat" ] && kill "$pid"
    done
}

reload_service() {
    stop
    start
}

service_triggers() {
    procd_add_reload_trigger "tvgate"
}
