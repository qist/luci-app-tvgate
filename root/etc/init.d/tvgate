#!/bin/sh /etc/rc.common

USE_PROCD=1
START=99

SERVICE_DAEMONIZE=1
SERVICE_WRITE_PID=1

BIN_PATH=/usr/bin/tvgate/TVGate
CONFIG_PATH=/etc/tvgate/config.yaml

start_service() {
	# Load configuration using UCI directly
	local enabled proxy listen_port
	
	enabled=$(uci get tvgate.@tvgate[0].enabled 2>/dev/null)
	[ "$enabled" != "1" ] && {
		echo "TVGate service is not enabled"
		return 1
	}
	
	proxy=$(uci get tvgate.@tvgate[0].proxy 2>/dev/null)
	listen_port=$(uci get tvgate.@tvgate[0].listen_port 2>/dev/null)
	
	# Set defaults
	[ -z "$proxy" ] && proxy="https://hk.gh-proxy.com/"
	[ -z "$listen_port" ] && listen_port="8888"
	
	# Create config directory
	mkdir -p /etc/tvgate
	
	# Start service only if binary exists
	if [ -f "$BIN_PATH" ]; then
		echo "Starting TVGate service..."
		procd_open_instance
		procd_set_param command "$BIN_PATH" "-config=$CONFIG_PATH"
		procd_set_param respawn
		procd_close_instance
		echo "TVGate service started"
	else
		echo "TVGate binary not found at $BIN_PATH, please download it via WebUI first"
		return 1
	fi
}

stop_service() {
	echo "Stopping TVGate service"
}

reload_service() {
	echo "Reloading TVGate service"
	stop
	start
}

service_triggers() {
	procd_add_reload_trigger "tvgate"
}