#!/bin/sh /etc/rc.common

USE_PROCD=1
START=99

BIN_PATH="/usr/bin/tvgate/TVGate"
CONFIG_PATH="/etc/tvgate/config.yaml"

start_service() {
    local enabled

    enabled="$(uci -q get tvgate.@tvgate[0].enabled)"
    [ "$enabled" != "1" ] && {
        logger -t tvgate "TVGate disabled in UCI"
        return 0
    }

    [ ! -x "$BIN_PATH" ] && {
        logger -t tvgate "TVGate binary not found: $BIN_PATH"
        return 1
    }

    mkdir -p /etc/tvgate

    procd_open_instance
    procd_set_param command "$BIN_PATH" "-config=$CONFIG_PATH"

    # 防止崩溃风暴：5 秒内最多 5 次
    procd_set_param respawn 5 5

    # 明确告诉 procd：这是前台程序
    procd_set_param stdout 1
    procd_set_param stderr 1

    procd_close_instance
}

stop_service() {
    :
}

reload_service() {
    stop
    start
}

service_triggers() {
    procd_add_reload_trigger "tvgate"
}
