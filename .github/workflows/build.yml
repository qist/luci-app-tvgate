name: Build TVGate

on:
  push:
    tags:
      - "*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.arch }} - OpenWrt ${{ matrix.version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch:
          - x86_64
        version:
          - 22.03.5
          - 25.12.0-rc2

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib \
            gettext git libncurses-dev libssl-dev python3 python3-setuptools \
            rsync unzip wget file xz-utils zstd

      # ------------------ 缓存 SDK + build_dir + downloads ------------------
      - name: Restore SDK cache
        uses: actions/cache@v3
        with:
          path: |
            $HOME/openwrt-sdk-*/staging_dir
            $HOME/openwrt-sdk-*/build_dir
            $HOME/openwrt-sdk-*/downloads
          key: ${{ runner.os }}-openwrt-sdk-${{ matrix.version }}-${{ hashFiles('**/feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-sdk-${{ matrix.version }}-

      # ------------------ 下载并解压 SDK（仅缓存未命中时执行） ------------------
      - name: Download and extract OpenWrt SDK
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          if [[ "${{ matrix.version }}" == "22.03.5" ]]; then
            SDK_URL=https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz
            wget $SDK_URL
            tar -xvf openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz -C $HOME
          else
            cd $HOME
            SDK_URL=https://archive.openwrt.org/releases/25.12.0-rc2/targets/x86/64/openwrt-sdk-25.12.0-rc2-x86-64_gcc-14.3.0_musl.Linux-x86_64.tar.zst
            wget $SDK_URL
            tar -I zstd -xf openwrt-sdk-25.12.0-rc2-x86-64_gcc-14.3.0_musl.Linux-x86_64.tar.zst
          fi
          SDK_DIR=$(find $HOME -maxdepth 1 -type d -name "openwrt-sdk*")
          echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV

      # ------------------ 生成 defconfig 并更新 feeds ------------------
      - name: Generate defconfig and update feeds
        run: |
          cd $SDK_DIR
          make defconfig
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ------------------ 克隆 luci-app-tvgate ------------------
      - name: Clone luci-app-tvgate
        run: |
          git clone https://github.com/qist/luci-app-tvgate $SDK_DIR/feeds/luci/applications/luci-app-tvgate || true
          cd $SDK_DIR/feeds/luci/applications/luci-app-tvgate
          git pull

      # ------------------ 安装 luci-app-tvgate feed ------------------
      - name: Install luci-app-tvgate feed
        run: |
          cd $SDK_DIR
          ./scripts/feeds update luci
          ./scripts/feeds install luci-app-tvgate

      # ------------------ 读取版本 ------------------
      - name: Read PKG_VERSION from Makefile
        run: |
          PKG_VERSION=$(grep "^PKG_VERSION:=" $SDK_DIR/feeds/luci/applications/luci-app-tvgate/Makefile | cut -d= -f2 | tr -d ' ')
          echo "PKG_VERSION=$PKG_VERSION" >> $GITHUB_ENV
          echo "Detected PKG_VERSION=$PKG_VERSION"

      # ------------------ 编译 luci-app-tvgate ------------------
      - name: Build luci-app-tvgate
        run: |
          cd $SDK_DIR
          make package/feeds/luci/luci-app-tvgate/compile V=s

      # ------------------ 收集生成的 ipk/apk ------------------
      - name: Collect artifact files
        id: collect_files
        run: |
          ARTIFACT_DIR="$SDK_DIR/bin/packages/x86_64/luci"
          FILES=()
          if [[ "${{ matrix.version }}" == "22.03.5" ]]; then
            FILES+=($ARTIFACT_DIR/luci-app-tvgate*.ipk $ARTIFACT_DIR/luci-i18n-tvgate*.ipk)
          else
            FILES+=($ARTIFACT_DIR/luci-app-tvgate*.apk $ARTIFACT_DIR/luci-i18n-tvgate*.apk)
          fi

          EXISTING_FILES=()
          for f in "${FILES[@]}"; do
            if [[ -f "$f" ]]; then
              EXISTING_FILES+=("$f")
            fi
          done

          if [ ${#EXISTING_FILES[@]} -eq 0 ]; then
            echo "No artifact files found!"
          else
            echo "Artifact files to upload:"
            for f in "${EXISTING_FILES[@]}"; do
              echo " - $f"
            done
          fi

          echo "artifact_files=${EXISTING_FILES[*]}" >> $GITHUB_OUTPUT

      # ------------------ 上传 artifacts ------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.arch }}-${{ matrix.version }}-v${{ env.PKG_VERSION }}
          path: ${{ steps.collect_files.outputs.artifact_files }}
