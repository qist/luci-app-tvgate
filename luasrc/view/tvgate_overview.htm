<%#
 Copyright 2023 OpenWrt.org
 Licensed to the public under the Apache License 2.0.
%>

<%+header%>

<h2 name="content"><%:TVGate%></h2>

<%
local fs = require "nixio.fs"
local sys = require "luci.sys"
local utl = require "luci.util"
local disp = require "luci.dispatcher"
local uci = require "luci.model.uci".cursor()

local tvgate_enabled = uci:get("tvgate", "tvgate", "enabled") or "0"
local binary_installed = fs.access("/usr/bin/tvgate/TVGate")
local running = (sys.call("pidof /usr/bin/tvgate/TVGate >/dev/null") == 0)

-- 从 YAML 配置文件中读取端口信息
local port = "8888" -- 默认端口
local yaml_config_path = "/etc/tvgate/config.yaml"

if fs.access(yaml_config_path) then
    local f = io.open(yaml_config_path, "r")
    if f then
        local content = f:read("*all")
        f:close()
        
        -- 查找端口配置
        for line in content:gmatch("[^\r\n]+") do
            local p = line:match("^%s*port:%s*(%d+)")
            if p then
                port = p
                break
            end
        end
    end
end

local listen_port = port
%>

<fieldset class="cbi-section">
	<legend><%=translate("Overview")%></legend>
	
	<div class="cbi-value">
		<label class="cbi-value-title"><%=translate("How to use")%></label>
		<div class="cbi-value-field">
			<span>
				<%=translate("Forward internal network resources (such as http, https, rtsp, rtp) to the external network through HTTP")%><br>
				<%=translate("Support multicast, unicast audio and video streams converted to HTTP accessible links")%><br>
				<%=translate("Built-in Web management interface for visual configuration")%><br>
				<%=translate("Support Docker deployment, systemd service management and OpenWrt system integration")%>
			</span>
		</div>
	</div>
	
	<div class="cbi-value">
		<label class="cbi-value-title"><%=translate("Usage instructions")%></label>
		<div class="cbi-value-field">
			<span>
				<ol>
					<li><%=translate("Configure the download proxy (e.g., https://hk.gh-proxy.com/) to speed up downloads")%></li>
					<li><%=translate("Click \"Download/Update Binary\" to download the TVGate executable")%></li>
					<li><%=translate("Enable the service and apply the settings")%></li>
					<li><%=translate("Access the web interface at http://[router-ip]:[streaming-port]/web/ to manage settings")%></li>
					<li><%=translate("Access IPTV streams at http://[router-ip]:[streaming-port]/channel-url")%></li>
					<li><%=translate("Monitor service status at http://[router-ip]:[streaming-port]/status")%></li>
				</ol>
			</span>
		</div>
	</div>
	
	<div class="cbi-value">
		<label class="cbi-value-title"><%=translate("Service Status")%></label>
		<div class="cbi-value-field">
			<span>
				<% if running then %>
					<em><b style="color:green"><%=translate("Running")%></b></em>
				<% else %>
					<em><b style="color:red"><%=translate("Stopped")%></b></em>
				<% end %>
			</span>
		</div>
	</div>
	
	<div class="cbi-value">
		<label class="cbi-value-title"><%=translate("Binary Status")%></label>
		<div class="cbi-value-field">
			<span>
				<% if binary_installed then %>
					<em><b style="color:green"><%=translate("Installed")%></b></em>
				<% else %>
					<em><b style="color:red"><%=translate("Not installed")%></b></em>
				<% end %>
			</span>
		</div>
	</div>
	
	<div class="cbi-value">
		<label class="cbi-value-title"><%=translate("Web Management")%></label>
		<div class="cbi-value-field">
			<span id="web-url"></span>
		</div>
	</div>
	<div class="cbi-value">
		<label class="cbi-value-title"><%=translate("Monitoring")%></label>
		<div class="cbi-value-field">
			<span id="monitor-url"></span>
		</div>
	</div>
	
	<div class="cbi-value">
		<label class="cbi-value-title"><%=translate("Streaming Port")%></label>
		<div class="cbi-value-field">
			<span><%=listen_port%></span>
		</div>
	</div>
	
	<div class="cbi-value">
		<label class="cbi-value-title"></label>
		<div class="cbi-value-field">
			<input type="button" class="btn cbi-button cbi-button-apply" value="<%=translate("Download/Update Binary")%>" onclick="downloadBinary()" id="download-btn" />
			</fieldset>

			<script type="text/javascript">
			//<![CDATA[
			function downloadBinary() {
				if (confirm('<%=translate("Are you sure you want to download/update the TVGate binary?")%>')) {
					var btn = document.getElementById('download-btn');
					btn.disabled = true;
					btn.value = '<%=translate("Downloading...")%>';
					XHR.get('<%=disp.build_url("admin", "services", "tvgate", "download")%>', null,
						function(x, data) {
							btn.disabled = false;
							btn.value = '<%=translate("Download/Update Binary")%>';
							if (!x.status && data) {
								if (data.result) {
									alert('<%=translate("TVGate binary downloaded successfully!")%>');
									location.reload();
								} else {
									var log = data.log || 'Unknown error';
									alert('<%=translate("Failed to download TVGate binary:")%>\n' + log);
								}
							} else {
								alert('<%=translate("Failed to download TVGate binary due to communication error.")%>');
							}
						}
					).catch(function(e) {
						btn.disabled = false;
						btn.value = '<%=translate("Download/Update Binary")%>';
						alert('<%=translate("Failed to download TVGate binary due to communication error.")%>');
					});
				}
			}
			//]]>
			</script>
		</div>
	</div>
</fieldset>

<script type="text/javascript">
//<![CDATA[
	function openTvgateInterface() {
		var btn = document.getElementById('open-webui-btn');
		var port = '<%=listen_port%>';
		
		XHR.get('<%=disp.build_url("admin", "services", "tvgate", "tvgate_config")%>', null, function(x, config) {
			if (config && !x.status) {
				var webPath = config.web_path || '/web/';
				var url = 'http://' + window.location.hostname + ':' + port + webPath;
				window.open(url, '_blank');
			} else {
				// Fallback to default
				window.open('http://' + window.location.hostname + ':' + port + '/web/', '_blank');
			}
		}).catch(function(e) {
			// Fallback to default on error
			window.open('http://' + window.location.hostname + ':' + port + '/web/', '_blank');
		});
	}
	
	// 直接显示管理和监控地址
	window.addEventListener('load', function() {
		XHR.get('<%=disp.build_url("admin", "services", "tvgate", "tvgate_config")%>', null, function(x, config) {
			if (config && !x.status) {
				var port = '<%=listen_port%>';
				var webPath = config.web_path || '/web/';
				var monitorPath = config.monitor_path || '/status';
				var webUrl = 'http://' + window.location.hostname + ':' + port + webPath;
				var monitorUrl = 'http://' + window.location.hostname + ':' + port + monitorPath;
				document.getElementById('web-url').innerHTML = '<a href="' + webUrl + '" target="_blank">' + webUrl + '</a>';
				document.getElementById('monitor-url').innerHTML = '<a href="' + monitorUrl + '" target="_blank">' + monitorUrl + '</a>';
			}
		}).catch(function(e) {
			document.getElementById('web-url').innerHTML = '-';
			document.getElementById('monitor-url').innerHTML = '-';
		});
	});
//]]>
</script>

<%+footer%>