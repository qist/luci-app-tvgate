<%+header%>

<h2><%:TVGate 管理配置%></h2>

<div class="cbi-section" style="margin-bottom: 10px;">
  <div style="padding:12px;border:1px solid #cce5ff;background:#e9f7ff;color:#084b8a;border-radius:6px;">
    <div style="font-weight:600;margin-bottom:6px;"><%:使用提示%></div>
    <ul style="margin:0;padding-left:18px;line-height:1.6;">
      <li><%:首次安装请先下载并启动 TVGate 二进制。%></li>
      <li><%:随后在此页面完善并保存配置。%></li>
      <li><%:保存配置后,确认修改已生效。%></li>
    </ul>
  </div>
  <br />
</div>
<form id="web-config-form" class="cbi-section">
  <div class="cbi-value">
    <label class="cbi-value-title"><%:Web 启用%></label>
    <div class="cbi-value-field">
      <input type="checkbox" id="web-enabled" value="1" />
    </div>
    <div class="cbi-value-description"><%:启用 Web 管理接口%></div>
  </div>
  <div class="cbi-value">
    <label class="cbi-value-title"><%:Web 用户名%></label>
    <div class="cbi-value-field">
      <input type="text" id="web-username" />
    </div>
    <div class="cbi-value-description"><%:用于登录管理页面的用户名%></div>
  </div>
  <div class="cbi-value">
    <label class="cbi-value-title"><%:Web 密码%></label>
    <div class="cbi-value-field">
      <div class="password-container">
        <input type="password" id="web-password" />
        <span class="password-toggle" onclick="togglePasswordVisibility('web-password')">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </span>
      </div>
    </div>
    <div class="cbi-value-description"><%:用于登录管理页面的密码%></div>
  </div>
  <div class="cbi-value">
    <label class="cbi-value-title"><%:Web 路径%></label>
    <div class="cbi-value-field">
      <input type="text" id="web-path" />
    </div>
    <div class="cbi-value-description"><%:Web 管理前缀路径，例如 /web/%></div>
  </div>
  <div class="cbi-value">
    <label class="cbi-value-title"><%:Streaming Port%></label>
    <div class="cbi-value-field">
      <input type="text" id="web-port" />
    </div>
    <div class="cbi-value-description"><%:服务监听端口（位于 server 分节）%></div>
  </div>
  <div class="cbi-value">
    <label class="cbi-value-title"><%:监控路径%></label>
    <div class="cbi-value-field">
      <input type="text" id="monitor-path" />
    </div>
    <div class="cbi-value-description"><%:状态接口路径，例如 /status%></div>
  </div>
  <div class="cbi-value">
    <label class="cbi-value-title"><%:日志启用%></label>
    <div class="cbi-value-field">
      <input type="checkbox" id="log-enabled" value="1" />
    </div>
    <div class="cbi-value-description"><%:是否启用日志输出%></div>
  </div>
  <div class="cbi-value">
    <label class="cbi-value-title"><%:日志文件%></label>
    <div class="cbi-value-field">
      <input type="text" id="log-file" />
    </div>
    <div class="cbi-value-description"><%:留空表示标准输出，否则写入指定文件路径%></div>
  </div>
  <div class="cbi-value">
    <label class="cbi-value-title"><%:日志最大大小(MB)%></label>
    <div class="cbi-value-field">
      <input type="text" id="log-maxsize" />
    </div>
    <div class="cbi-value-description"><%:达到大小后进行轮转%></div>
  </div>
  <div class="cbi-value">
    <label class="cbi-value-title"><%:日志备份个数%></label>
    <div class="cbi-value-field">
      <input type="text" id="log-maxbackups" />
    </div>
    <div class="cbi-value-description"><%:保留的压缩备份文件数量%></div>
  </div>
  <div class="cbi-value">
    <label class="cbi-value-title"><%:日志保留天数%></label>
    <div class="cbi-value-field">
      <input type="text" id="log-maxage" />
    </div>
    <div class="cbi-value-description"><%:日志文件保留的天数%></div>
  </div>
  <div class="cbi-value">
    <label class="cbi-value-title"><%:日志压缩%></label>
    <div class="cbi-value-field">
      <input type="checkbox" id="log-compress" value="1" />
    </div>
    <div class="cbi-value-description"><%:是否压缩轮转产生的日志文件%></div>
  </div>
  <div class="cbi-value">
    <label class="cbi-value-title"></label>
    <div class="cbi-value-field">
      <input type="button" class="btn cbi-button cbi-button-apply" value="<%:保存%>" onclick="saveWebConfig()" />
    </div>
  </div>
</form>

<style>
.password-container {
  position: relative;
  display: inline-block;
  width: 100%;
}

.password-container input {
  width: calc(100% - 35px);
  padding-right: 35px;
}

.password-toggle {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  z-index: 10;
}

.password-toggle:hover {
  opacity: 0.7;
}
</style>

<script type="text/javascript">
//<![CDATA[
function loadWebConfig() {
  XHR.get('<%=url("admin/services/tvgate/web")%>', null, function(x, data) {
    if (data) {
      document.getElementById('web-enabled').checked = data.enabled === true;
      document.getElementById('web-username').value = data.username || 'admin';
      document.getElementById('web-password').value = data.password || 'admin';
      document.getElementById('web-path').value = data.path || '/web/';
      document.getElementById('monitor-path').value = data.monitor_path || '/status';
      document.getElementById('web-port').value = data.port || '8888';
      document.getElementById('log-enabled').checked = data.log_enabled === true;
      document.getElementById('log-file').value = data.log_file || '';
      document.getElementById('log-maxsize').value = data.log_maxsize || '10';
      document.getElementById('log-maxbackups').value = data.log_maxbackups || '10';
      document.getElementById('log-maxage').value = data.log_maxage || '28';
      document.getElementById('log-compress').checked = data.log_compress === true;
    }
  });
}

function saveWebConfig() {
  XHR.post('<%=url("admin/services/tvgate/web")%>', {
    enabled: document.getElementById('web-enabled').checked ? 'true' : 'false',
    username: document.getElementById('web-username').value,
    password: document.getElementById('web-password').value,
    path: document.getElementById('web-path').value,
    monitor_path: document.getElementById('monitor-path').value,
    port: document.getElementById('web-port').value,
    log_enabled: document.getElementById('log-enabled').checked ? 'true' : 'false',
    log_file: document.getElementById('log-file').value,
    log_maxsize: document.getElementById('log-maxsize').value,
    log_maxbackups: document.getElementById('log-maxbackups').value,
    log_maxage: document.getElementById('log-maxage').value,
    log_compress: document.getElementById('log-compress').checked ? 'true' : 'false'
  }, function(x, data) {
    alert(data && data.success ? '<%:保存成功！%>' : '<%:保存失败！%>');
  });
}

function togglePasswordVisibility(fieldId) {
  var passwordField = document.getElementById(fieldId);
  var svgElement = passwordField.parentElement.querySelector('.password-toggle svg');
  
  if (passwordField.type === 'password') {
    passwordField.type = 'text';
    // 更改为隐藏眼睛的图标
    svgElement.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.94 9.94A10.07 10.07 0 0 1 12 4c7 0 11 8 11 8a18.45 18.45 0 0 1-5.06 5.94M1 1h22M16 11h6m-3-3v6" />';
  } else {
    passwordField.type = 'password';
    // 更改为显示眼睛的图标
    svgElement.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
  }
}

window.onload = loadWebConfig;
//]]>
</script>

<%+footer%>